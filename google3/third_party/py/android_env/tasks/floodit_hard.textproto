# proto-file: google3/third_party/py/android_env/proto/task.proto
# proto-message: android_env.Task

id: "floodit_hard"
name: "FloodIt - Hard"
description: "A game where you have to flood the entire grid with the same color."
package_name: "com.google.example.games.floodit"
full_activity_name: "com.google.example.games.floodit/com.google.example.games.floodit.FloodIt"

setup_steps: [
  {
    adb_call: {
      install_apk: {
        apk_source: FIRST_PARTY
        mpm: {
          package_name: "learning/deepmind/research/xgames/android/apks/floodit"
          label: "0.6"
          path: "2020.10.14-floodit_cxless_debug_alldpi_x86.apk"
        }
      }
    }
    success_condition: {
      check_install: {
        package_name: "com.google.example.games.floodit"
        timeout_sec: 10.0
      }
    }
  }
]

reset_steps: [
  { adb_call: { force_stop: { package_name: "com.google.example.games.floodit" } } },
  { adb_call: { clear_cache: { package_name: "com.google.example.games.floodit" } } },
  {
    adb_call: {
      grant_permissions: {
        package_name: "com.google.example.games.floodit"
        permissions: "android.permission.ACCESS_COARSE_LOCATION"
      }
    }
  },
  {
    adb_call: {
      start_activity: {
        full_activity: "com.google.example.games.floodit/.FloodItSplash"
        extra_args: [
            "--ez", '"RL_TASK_ENABLED"', '"true"',
            # basicScore: replace game score with #steps left + 1 (if won), 0 (if lost)
            "--es", '"RL_TASK_GAME_CONFIG"', '"{\\"boardSize\\":24,\\"maxSteps\\":42,\\"basicScore\\":true}"'
        ]
      }
    }
    success_condition: {
      wait_for_app_screen: {
        app_screen: {
          activity: "com.google.example.games.floodit/com.google.example.games.floodit.FloodIt"
          view_hierarchy_path: [
              # "^DecorView@.*\\[FloodIt\\]$",
              # "^android.widget.LinearLayout\\{.*\\}$",
              # "^android.widget.FrameLayout\\{.*\\}$",
              # "^android.support.v7.widget.FitWindowsLinearLayout\\{.*app\\:id\\/action_bar_root\\}$",
              # "^android.support.v7.widget.ContentFrameLayout\\{.*android:id/content\\}$"
          ]
        }
        timeout_sec: 10.0
      }
      num_retries: 10
    }
  },
  {
    adb_call: {
      start_screen_pinning: {
        full_activity: "com.google.example.games.floodit/com.google.example.games.floodit.FloodIt"
      }
    }
  }
]

expected_app_screen: {
  activity: "com.google.example.games.floodit/com.google.example.games.floodit.FloodIt"
  view_hierarchy_path: [
    # "^DecorView@.*\\[FloodIt\\]$",
    # "^android.widget.LinearLayout\\{.*\\}$",
    # "^android.widget.FrameLayout\\{.*\\}$",
    # "^android.support.v7.widget.FitWindowsLinearLayout\\{.*app\\:id\\/action_bar_root\\}$",
    # "^android.support.v7.widget.ContentFrameLayout\\{.*android:id/content\\}$"
  ]
}

max_duration_sec: 300  # 5 minutes.

extras_spec: [
  # State of the board, representing colours by their indices
  # 0: purple, 1: blue, 2: green, 3: yellow, 4: red, 5: pink
  # Returned when the board changes
  { name: "board" shape: [24, 24], dtype: INT32 },
  # Index of the colour clicked (between 0-5)
  # Returned when clicked
  { name: "clicked" shape: [1], dtype: INT32 },
  # The number of new cells that just got merged into the big blob (0 or more)
  # Returned when the board state changes
  { name: "flipped" shape: [1], dtype: INT32 }
]
