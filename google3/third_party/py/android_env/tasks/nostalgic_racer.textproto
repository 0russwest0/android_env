# proto-file: google3/third_party/py/android_env/proto/task.proto
# proto-message: android_env.Task

id: "nostalgic_racer"
name: "Nostalgic Racer 3D"
description: "A simple racing game in which the agent taps on the screen to control the car."
package_name: "com.google.example.games.nostalgicracer"
full_activity_name: "com.google.example.games.nostalgicracer/com.google.example.games.nostalgicracer.MainActivity"
log_tag: "NostalgicRacer"

setup_steps: [
  {
    adb_call: {
      install_apk: {
        apk_source: FIRST_PARTY
        mpm: {
          package_name: "learning/deepmind/research/xgames/android/apks/nostalgic_racer"
          label: "0.4"
          path: "2020.05.06-nostalgicracer_debug_alldpi_x86.apk"
        }
      }
    }
    success_condition: {
      check_install: {
        package_name: "com.google.example.games.nostalgicracer"
        timeout_sec: 10.0
      }
    }
  }
]

reset_steps: [
  { adb_call: { force_stop: { package_name: "com.google.example.games.nostalgicracer" } } },
  { adb_call: { clear_cache: { package_name: "com.google.example.games.nostalgicracer" } } },
  {
    adb_call: {
      grant_permissions: {
        package_name: "com.google.example.games.nostalgicracer"
        permissions: "android.permission.ACCESS_COARSE_LOCATION"
      }
    }
  },
  {
    adb_call: {
      start_activity: {
        full_activity: "com.google.example.games.nostalgicracer/com.google.example.games.nostalgicracer.MainActivity"
        extra_args: [
            "--ez", '"RL_TASK_ENABLED"', '"true"',
            "--es", '"RL_TASK_GAME_CONFIG"', '"{\\"use3d\\":true}"'
        ]
      }
    }
    success_condition: {
      wait_for_app_screen: {
        app_screen: {
          activity: "com.google.example.games.nostalgicracer/com.google.example.games.nostalgicracer.MainActivity"
          view_hierarchy_path: [
              "^DecorView@.*\\[MainActivity\\]$",
              "^android.widget.LinearLayout\\{.*\\}$",
              "^android.widget.FrameLayout\\{.*android\\:id\\/content\\}",
              "^android.widget.RelativeLayout\\{.*\\}",
              "^android.widget.FrameLayout\\{.*app\\:id\\/fragment_holder\\}",
              "^android.widget.RelativeLayout\\{.*\\}",
              "^com.google.example.games.nostalgicracer.views.RaceView3D\\{.*app\\:id\\/gameplay_screen_3d\\}"
          ]
        }
        timeout_sec: 10.0
      }
      num_retries: 10
    }
  },
  {
    adb_call: {
      start_screen_pinning: {
        full_activity: "com.google.example.games.nostalgicracer/com.google.example.games.nostalgicracer.MainActivity"
      }
    }
  }
]

expected_app_screen: {
  activity: "com.google.example.games.nostalgicracer/com.google.example.games.nostalgicracer.MainActivity"
  view_hierarchy_path: "^DecorView@.*\\[MainActivity\\]$"
  view_hierarchy_path: "^android.widget.LinearLayout\\{.*\\}$"
  view_hierarchy_path: "^android.widget.FrameLayout\\{.*android\\:id\\/content\\}"
  view_hierarchy_path: "^android.widget.RelativeLayout\\{.*\\}"
  view_hierarchy_path: "^android.widget.FrameLayout\\{.*app\\:id\\/fragment_holder\\}"
  view_hierarchy_path: "^android.widget.RelativeLayout\\{.*\\}"
  view_hierarchy_path: "^com.google.example.games.nostalgicracer.views.RaceView3D\\{.*app\\:id\\/gameplay_screen_3d\\}"
}

max_duration_sec: 600  # 10 minutes.

extras_spec: [
  # All of these a returned when the racer moves
  # The state of the racer (NORMAL, REVIVING, DEAD...)
  { name: "state" shape: [1], dtype: STRING_U16 },
  # The collision item type: 0=NONE, 1=BRICK, 2=TURBO, 3=ROUGH, 4=OIL, 5=COIN, 6=SUPER_COIN, 7=COUNT
  { name: "collision" shape: [1], dtype: INT32 },
  # The difficulty level
  { name: "difficulty" shape: [1], dtype: INT32 },
  # When the racer passes a checkpoint
  { name: "checkpoint" shape: [1], dtype: INT32 }
]
